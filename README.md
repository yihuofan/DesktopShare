# DesktopShare V1: 基于FFmpeg的多线程RTSP推流客户端

当前版本是一个在Linux上运行的、低性能的、纯后端的屏幕直播推流工具。作为后续项目的起点。

## 流程

捕获Linux桌面 -\> H.264软件编码 -\> 推流到 MediaMTX RTSP服务器。

## 架构设计

本项目采用多线程“生产者-消费者”模型，将屏幕捕获、视频编码和网络推流三个核心任务解耦。

 1.  **采集线程 (Capture)**
      **功能**: 利用 FFmpeg 的 `libavdevice` 库和 `x11grab` 输入格式，在 X11 系统从桌面环境中捕获原始屏幕图像数据。

2.  **编码线程 (Encoder)**

      **功能**: 从“原始帧队列”中取出图像，使用 `libx264` 编码器将其压缩为 H.264 视频包。

3.  **推流线程 (Streamer)**

      **功能**: 从“编码包队列”中获取数据，将其封装为 RTSP 协议格式，并通过网络发送到远端服务器。

4.  **线程间通信**

      **功能**: 使用了两个 `ThreadSafeQueue<T>` 模板类的实例。

## 技术栈

  * **核心库**: **FFmpeg7.1**
      * `libavdevice`: 用于屏幕捕获。
      * `libavcodec`: 负责视频的编码和解码。
      * `libavformat`: 用于 RTSP 协议的封装与推流。
      * `libswscale`: 用于图像的缩放和像素格式转换。

## 如何构建和运行

### 依赖项

确保已安装以下依赖：

  * GCC/G++
  * CMake
  * FFmpeg 开发库（我用的已编译的linux上的ffmpeg）
```

### 构建

mkdir build && cd build
cmake ..
make
```

## 当前状态

V1版本验证了FFmpeg和多线程进行屏幕直播的技术。

-----

## 后续迭代计划

### 第二版：移除对外部RTSP服务器的依赖，集成网络库，让程序自身成为rtsp服务器。

### 第三版：提高性能，替换为原生屏幕捕获等。

### 第四版：尝试 OpenGL与ImGui 增加图形化界面

### 第五版：增加音频采集和编码，支持NVIDIA硬件编码器，多协议，同时支持RTSP服务和RTMP推流，在UI中提供对码率、帧率、GOP等核心编码参数的动态调整。